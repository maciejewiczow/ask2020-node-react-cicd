version: 2.1

orbs:
  node: circleci/node@1.1.6
  docker: circleci/docker@1.2.1

jobs:
  build-and-test-client:
    executor:
      name: node/default
    steps:
      - checkout
      - node/install-packages:
          app-dir: './client'
      - run:
          command: |
            cd ./client
            npm test
          name: "npm test"

  build-and-test-server:
    executor:
      name: node/default
    steps:
      - checkout
      - node/install-packages:
        app-dir: './server'
      - run:
          command: |
            cd ./server
            npm test
          name: "npm install & test"

  docker-publish-client:
    docker:
      - image: circleci/buildpack-deps:stretch
    steps:
      - docker/check
      - docker/publish:
          docker-context: ./client
          image: "Client:latest"

  docker-publish-api:
    docker:
      - image: circleci/buildpack-deps:stretch
    steps:
      - docker/check
      - docker/publish:
          docker-context: ./server
          image: "API:latest"

workflows:
    build-and-test:
      jobs:
        - build-and-test-client
        - build-and-test-server
        - docker-publish-client:
            requires:
              - build-and-test-client
        - docker-publish-api:
            requires:
              - build-and-test-server
